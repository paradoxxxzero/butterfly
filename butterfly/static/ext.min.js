/*! butterfly           2014-07-18 */

(function(){var a,b,c,d,e,f,g,h,i,j,k=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};i=function(a){var b;return b=function(c){var d;return butterfly.element.classList.remove("alarm"),d="New activity on butterfly terminal ["+butterfly.title+"]",a?new Notification(d,{body:c.data,icon:"/static/images/favicon.png"}):alert(d+"\n"+c.data),butterfly.ws.removeEventListener("message",b)},butterfly.ws.addEventListener("message",b),butterfly.element.classList.add("alarm")},c=function(a){return a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation(),a.cancelBubble=!0,!1},document.addEventListener("keydown",function(a){return a.altKey&&65===a.keyCode?(Notification&&"default"===Notification.permission?Notification.requestPermission(function(){return i("granted"===Notification.permission)}):i("granted"===Notification.permission),c(a)):!0}),h=null,c=function(a){return a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation(),a.cancelBubble=!0,!1},g=function(a){var b;for(b=a.previousSibling,b||(b=a.parentNode.previousSibling),b||(b=a.parentNode.parentNode.previousSibling);b.lastChild;)b=b.lastChild;return b},f=function(a){var b;for(b=a.nextSibling,b||(b=a.parentNode.nextSibling),b||(b=a.parentNode.parentNode.nextSibling);b.firstChild;)b=b.firstChild;return b},a=function(){function a(){butterfly.element.classList.add("selection"),this.selection=getSelection()}return a.prototype.reset=function(){var a,b,c;for(this.selection=getSelection(),a=document.createRange(),a.setStart(this.selection.anchorNode,this.selection.anchorOffset),a.setEnd(this.selection.focusNode,this.selection.focusOffset),this.start={node:this.selection.anchorNode,offset:this.selection.anchorOffset},this.end={node:this.selection.focusNode,offset:this.selection.focusOffset},a.collapsed&&(b=[this.end,this.start],this.start=b[0],this.end=b[1]),this.start_line=this.start.node;!this.start_line.classList||k.call(this.start_line.classList,"line")<0;)this.start_line=this.start_line.parentNode;for(this.end_line=this.end.node,c=[];!this.end_line.classList||k.call(this.end_line.classList,"line")<0;)c.push(this.end_line=this.end_line.parentNode);return c},a.prototype.clear=function(){return this.selection.removeAllRanges()},a.prototype.destroy=function(){return butterfly.element.classList.remove("selection"),this.clear()},a.prototype.text=function(){return this.selection.toString()},a.prototype.up=function(){return this.go(-1)},a.prototype.down=function(){return this.go(1)},a.prototype.go=function(a){var b;if(b=butterfly.children.indexOf(this.start_line)+a,b>=0&&b<butterfly.children.length){for(;!butterfly.children[b].textContent.match(/\S/);)if(b+=a,!(b>=0&&b<butterfly.children.length))return;return this.select_line(b)}},a.prototype.apply=function(){var a;return this.clear(),a=document.createRange(),a.setStart(this.start.node,this.start.offset),a.setEnd(this.end.node,this.end.offset),this.selection.addRange(a)},a.prototype.select_line=function(a){var b,c,d;return b=butterfly.children[a],d={node:b.firstChild,offset:0},c={node:b.lastChild,offset:b.lastChild.textContent.length},this.start=this.walk(d,/\S/),this.end=this.walk(c,/\S/,!0)},a.prototype.collapsed=function(a,b){var c;return c=document.createRange(),c.setStart(a.node,a.offset),c.setEnd(b.node,b.offset),c.collapsed},a.prototype.shrink_right=function(){var a,b;return b=this.walk(this.end,/\s/,!0),a=this.walk(b,/\S/,!0),this.collapsed(this.start,a)?void 0:this.end=a},a.prototype.shrink_left=function(){var a,b;return a=this.walk(this.start,/\s/),b=this.walk(a,/\S/),this.collapsed(b,this.end)?void 0:this.start=b},a.prototype.expand_right=function(){var a;return a=this.walk(this.end,/\S/),this.end=this.walk(a,/\s/)},a.prototype.expand_left=function(){var a;return a=this.walk(this.start,/\S/,!0),this.start=this.walk(a,/\s/,!0)},a.prototype.walk=function(a,b,c){var d,e,h;if(null==c&&(c=!1),e=a.node.firstChild?a.node.firstChild:a.node,h=e.textContent,d=a.offset,c)for(;e;){for(;d>0;)if(h[--d].match(b))return{node:e,offset:d+1};e=g(e),h=e.textContent,d=h.length}else for(;e;){for(;d<h.length;)if(h[d++].match(b))return{node:e,offset:d-1};e=f(e),h=e.textContent,d=0}return a},a}(),document.addEventListener("keydown",function(b){var d,e;if(d=b.keyCode,k.call([16,17,18,19],d)>=0)return!0;if(b.shiftKey&&13===b.keyCode&&!h&&!getSelection().isCollapsed)return butterfly.handler(getSelection().toString()),getSelection().removeAllRanges(),c(b);if(h){if(h.reset(),!b.ctrlKey&&b.shiftKey&&37<=(e=b.keyCode)&&40>=e)return!0;if(b.shiftKey&&b.ctrlKey)38===b.keyCode?h.up():40===b.keyCode&&h.down();else if(39===b.keyCode)h.shrink_left();else if(38===b.keyCode)h.expand_left();else if(37===b.keyCode)h.shrink_right();else{if(40!==b.keyCode)return c(b);h.expand_right()}return null!=h&&h.apply(),c(b)}return!h&&b.ctrlKey&&b.shiftKey&&38===b.keyCode?(h=new a,h.select_line(butterfly.y-1),h.apply(),c(b)):!0}),document.addEventListener("keyup",function(a){var b,d;if(b=a.keyCode,k.call([16,17,18,19],b)>=0)return!0;if(h){if(13===a.keyCode)return butterfly.handler(h.text()),h.destroy(),h=null,c(a);if(d=a.keyCode,k.call([37,38,39,40],d)<0)return h.destroy(),h=null,!0}return!0}),document.addEventListener("dblclick",function(a){var b,c,d,e,f;if(!(a.ctrlKey||a.altkey||(f=getSelection(),f.isCollapsed||f.toString().match(/\s/)))){for(e=document.createRange(),e.setStart(f.anchorNode,f.anchorOffset),e.setEnd(f.focusNode,f.focusOffset),e.collapsed&&(f.removeAllRanges(),d=document.createRange(),d.setStart(f.focusNode,f.focusOffset),d.setEnd(f.anchorNode,f.anchorOffset),f.addRange(d)),e.detach();!f.toString().match(/\s/)&&f.toString();)f.modify("extend","forward","character");for(f.modify("extend","backward","character"),b=f.anchorNode,c=f.anchorOffset,f.collapseToEnd(),f.extend(b,c);!f.toString().match(/\s/)&&f.toString();)f.modify("extend","backward","character");return f.modify("extend","forward","character")}}),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(d=!1,b=!1,e=!0,j=document.createElement("input"),j.type="password",j.style.position="fixed",j.style.top=0,j.style.left=0,j.style.border="none",j.style.outline="none",j.style.opacity=0,j.value="0",document.body.appendChild(j),j.addEventListener("blur",function(){return setTimeout(function(a){return function(){return a.focus()}}(this),10)}),addEventListener("click",function(){return j.focus()}),addEventListener("touchstart",function(a){return 2===a.touches.length?d=!0:3===a.touches.length?(d=!1,b=!0):4===a.touches.length?(d=!0,b=!0):void 0}),j.addEventListener("keydown",function(a){return butterfly.keyDown(a),!0}),j.addEventListener("input",function(a){var c;return c=this.value.length,0===c?(a.keyCode=8,butterfly.keyDown(a),this.value="0",!0):(a.keyCode=this.value.charAt(1).charCodeAt(0),!d&&!b||e?(butterfly.keyPress(a),e=!1,this.value="0",!0):(a.keyCode=this.value.charAt(1).charCodeAt(0),a.ctrlKey=d,a.altKey=b,a.keyCode>=97&&a.keyCode<=122&&(a.keyCode-=32),butterfly.keyDown(a),this.value="0",d=b=!1,!0))}))}).call(this);
//# sourceMappingURL=ext.min.js.map